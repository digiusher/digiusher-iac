AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Consolidated CloudFormation template for DigiUsher AWS integration.
  Supports multiple deployment scenarios for both root and linked accounts.
  Includes options for CUR 1.0, CUR 2.0, and Carbon Footprint reporting.
  Must be deployed in us-east-1 region for billing-related resources.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Account Configuration"
        Parameters:
          - AccountType
          - DeploymentScenario
      - Label:
          default: "IAM Role Configuration"
        Parameters:
          - RoleName
          - ExternalId
      - Label:
          default: "Data Export Configuration (Root Account Only)"
        Parameters:
          - BucketName
          - DataExportName
          - CURVersion
          - EnableCarbonFootprint
      - Label:
          default: "Additional Permissions (Optional)"
        Parameters:
          - IncludeEC2StartStopPermissions
          - IncludeS3DuplicateObjectsPermission

Mappings:
  DataExports:
    CUR2:
      DefaultQuery: >-
        SELECT bill_bill_type, bill_billing_entity, bill_billing_period_end_date, bill_billing_period_start_date, bill_invoice_id, bill_invoicing_entity, bill_payer_account_id, bill_payer_account_name, cost_category, discount, discount_bundled_discount, discount_total_discount, identity_line_item_id, identity_time_interval, line_item_availability_zone, line_item_blended_cost, line_item_blended_rate, line_item_currency_code, line_item_legal_entity, line_item_line_item_description, line_item_line_item_type, line_item_net_unblended_cost, line_item_net_unblended_rate, line_item_normalization_factor, line_item_normalized_usage_amount, line_item_operation, line_item_product_code, line_item_resource_id, line_item_tax_type, line_item_unblended_cost, line_item_unblended_rate, line_item_usage_account_id, line_item_usage_account_name, line_item_usage_amount, line_item_usage_end_date, line_item_usage_start_date, line_item_usage_type, pricing_currency, pricing_lease_contract_length, pricing_offering_class, pricing_public_on_demand_cost, pricing_public_on_demand_rate, pricing_purchase_option, pricing_rate_code, pricing_rate_id, pricing_term, pricing_unit, product, product_comment, product_fee_code, product_fee_description, product_from_location, product_from_location_type, product_from_region_code, product_instance_family, product_instance_type, product_instancesku, product_location, product_location_type, product_operation, product_pricing_unit, product_product_family, product_region_code, product_servicecode, product_sku, product_to_location, product_to_location_type, product_to_region_code, product_usagetype, reservation_amortized_upfront_cost_for_usage, reservation_amortized_upfront_fee_for_billing_period, reservation_availability_zone, reservation_effective_cost, reservation_end_time, reservation_modification_status, reservation_net_amortized_upfront_cost_for_usage, reservation_net_amortized_upfront_fee_for_billing_period, reservation_net_effective_cost, reservation_net_recurring_fee_for_usage, reservation_net_unused_amortized_upfront_fee_for_billing_period, reservation_net_unused_recurring_fee, reservation_net_upfront_value, reservation_normalized_units_per_reservation, reservation_number_of_reservations, reservation_recurring_fee_for_usage, reservation_reservation_a_r_n, reservation_start_time, reservation_subscription_id, reservation_total_reserved_normalized_units, reservation_total_reserved_units, reservation_units_per_reservation, reservation_unused_amortized_upfront_fee_for_billing_period, reservation_unused_normalized_unit_quantity, reservation_unused_quantity, reservation_unused_recurring_fee, reservation_upfront_value, resource_tags, savings_plan_amortized_upfront_commitment_for_billing_period, savings_plan_end_time, savings_plan_instance_type_family, savings_plan_net_amortized_upfront_commitment_for_billing_period, savings_plan_net_recurring_commitment_for_billing_period, savings_plan_net_savings_plan_effective_cost, savings_plan_offering_type, savings_plan_payment_option, savings_plan_purchase_term, savings_plan_recurring_commitment_for_billing_period, savings_plan_region, savings_plan_savings_plan_a_r_n, savings_plan_savings_plan_effective_cost, savings_plan_savings_plan_rate, savings_plan_start_time, savings_plan_total_commitment_to_date, savings_plan_used_commitment, split_line_item_actual_usage, split_line_item_net_split_cost, split_line_item_net_unused_cost, split_line_item_parent_resource_id, split_line_item_public_on_demand_split_cost, split_line_item_public_on_demand_unused_cost, split_line_item_reserved_usage, split_line_item_split_cost, split_line_item_split_usage, split_line_item_split_usage_ratio, split_line_item_unused_cost FROM COST_AND_USAGE_REPORT

Parameters:
  AccountType:
    Type: String
    Description: Type of AWS account being configured
    AllowedValues:
      - Root
      - Linked
    Default: Root

  DeploymentScenario:
    Type: String
    Description: Deployment scenario for the root account (NewBucketNewExport recommended)
    AllowedValues:
      - NewBucketNewExport
      - ExistingBucketNewExport
      - ExistingBucketExistingExport
      - LinkedAccount
    Default: NewBucketNewExport

  RoleName:
    Type: String
    Description: Name for the IAM Role that DigiUsher will assume
    MinLength: 1
    MaxLength: 64
    ConstraintDescription: Role name must be between 1 and 64 characters

  ExternalId:
    Type: String
    Description: External ID for secure role assumption (prevents confused deputy problem)
    MinLength: 2
    MaxLength: 1224
    NoEcho: true
    ConstraintDescription: External ID must be between 2 and 1224 characters

  BucketName:
    Type: String
    Description: Name of the S3 bucket for storing Cost and Usage Reports (required for root accounts with data exports)
    Default: ""

  DataExportName:
    Type: String
    Description: Name for the data export (CUR 1.0 or CUR 2.0)
    Default: "DigiUsher_CUR_Export"

  CURVersion:
    Type: String
    Description: Cost and Usage Report version (only applicable when creating new exports)
    AllowedValues:
      - CUR1
      - CUR2
    Default: CUR2

  EnableCarbonFootprint:
    Type: String
    Description: Enable Carbon Footprint Report export (Root account only)
    AllowedValues:
      - "yes"
      - "no"
    Default: "no"

  IncludeEC2StartStopPermissions:
    Type: String
    Description: Include EC2 start/stop permissions
    AllowedValues:
      - "yes"
      - "no"
    Default: "no"

  IncludeS3DuplicateObjectsPermission:
    Type: String
    Description: Include S3 ListBucket permission for duplicate object detection
    AllowedValues:
      - "yes"
      - "no"
    Default: "no"

Conditions:
  IsRootAccount: !Equals [!Ref AccountType, "Root"]
  IsLinkedAccount: !Equals [!Ref AccountType, "Linked"]

  # Deployment scenario conditions
  CreateBucket: !And
    - !Condition IsRootAccount
    - !Equals [!Ref DeploymentScenario, "NewBucketNewExport"]

  CreateDataExport: !And
    - !Condition IsRootAccount
    - !Or
      - !Equals [!Ref DeploymentScenario, "NewBucketNewExport"]
      - !Equals [!Ref DeploymentScenario, "ExistingBucketNewExport"]

  HasExistingBucket: !Or
    - !Equals [!Ref DeploymentScenario, "ExistingBucketExistingExport"]
    - !Equals [!Ref DeploymentScenario, "ExistingBucketNewExport"]

  NeedsBucketAccess: !And
    - !Condition IsRootAccount
    - !Not [!Equals [!Ref DeploymentScenario, "LinkedAccount"]]

  # CUR version conditions
  IsCUR1: !And
    - !Condition CreateDataExport
    - !Equals [!Ref CURVersion, "CUR1"]

  IsCUR2: !And
    - !Condition CreateDataExport
    - !Equals [!Ref CURVersion, "CUR2"]

  # Carbon footprint condition
  EnableCarbonFootprintReport: !And
    - !Condition IsRootAccount
    - !Equals [!Ref EnableCarbonFootprint, "yes"]

  # Additional permissions conditions
  IncludeEC2StartStopPermissionsCondition: !Equals [!Ref IncludeEC2StartStopPermissions, "yes"]
  IncludeS3DuplicateObjectsPermissionCondition: !Equals [!Ref IncludeS3DuplicateObjectsPermission, "yes"]

  # Region validation
  IsUSEast1: !Equals [!Ref 'AWS::Region', 'us-east-1']

Rules:
  ValidateBucketNameForRootAccount:
    RuleCondition: !Condition NeedsBucketAccess
    Assertions:
      - Assert: !Not [!Equals [!Ref BucketName, ""]]
        AssertDescription: "BucketName is required when AccountType is Root and deployment scenario requires bucket access"

  ValidateUSEast1ForBilling:
    RuleCondition: !Or
      - !Condition CreateBucket
      - !Condition CreateDataExport
      - !Condition EnableCarbonFootprintReport
    Assertions:
      - Assert: !Condition IsUSEast1
        AssertDescription: "This template must be deployed in us-east-1 region for billing-related resources (CUR, Carbon Footprint)"

Resources:
  # S3 Bucket for new bucket scenario
  DigiusherS3Bucket:
    Type: AWS::S3::Bucket
    Condition: CreateBucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Description: |
      Creates an S3 bucket to store Cost and Usage Reports and Carbon Footprint data.
    Properties:
      BucketName: !Ref BucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 90
      Tags:
        - Key: ManagedBy
          Value: DigiUsher
        - Key: Purpose
          Value: CostAndUsageReports

  # S3 Bucket Policy for billing service access
  DigiusherS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateBucket
    DependsOn: DigiusherS3Bucket
    Description: |
      Grants AWS billing services permission to write reports to the S3 bucket.
    Properties:
      Bucket: !Ref DigiusherS3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowBillingServiceAccess
            Effect: Allow
            Principal:
              Service:
                - billingreports.amazonaws.com
                - bcm-data-exports.amazonaws.com
            Action:
              - s3:GetBucketAcl
              - s3:GetBucketPolicy
              - s3:PutObject
            Resource:
              - !Sub 'arn:${AWS::Partition}:s3:::${DigiusherS3Bucket}'
              - !Sub 'arn:${AWS::Partition}:s3:::${DigiusherS3Bucket}/*'
            Condition:
              StringLike:
                aws:SourceArn:
                  - !Sub 'arn:aws:cur:us-east-1:${AWS::AccountId}:definition/*'
                  - !Sub 'arn:aws:bcm-data-exports:us-east-1:${AWS::AccountId}:export/*'
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  # CUR 1.0 Report Definition
  DigiUsherCUR1:
    Type: AWS::CUR::ReportDefinition
    Condition: IsCUR1
    DependsOn:
      - !If [CreateBucket, !Ref DigiusherS3BucketPolicy, !Ref AWS::NoValue]
    Description: |
      Defines a Cost and Usage Report 1.0 to capture detailed usage and cost data.
    Properties:
      ReportName: !Ref DataExportName
      TimeUnit: DAILY
      Format: Parquet
      Compression: Parquet
      AdditionalSchemaElements:
        - RESOURCES
        - SPLIT_COST_ALLOCATION_DATA
      S3Bucket: !If [CreateBucket, !Ref DigiusherS3Bucket, !Ref BucketName]
      S3Prefix: reports/cur1
      S3Region: !Ref AWS::Region
      RefreshClosedReports: true
      ReportVersioning: OVERWRITE_REPORT
      AdditionalArtifacts:
        - ATHENA

  # CUR 2.0 Data Export
  DigiUsherCUR2:
    Type: AWS::BCMDataExports::Export
    Condition: IsCUR2
    DependsOn:
      - !If [CreateBucket, !Ref DigiusherS3BucketPolicy, !Ref AWS::NoValue]
    Description: |
      Defines a Cost and Usage Report 2.0 (CUR) to capture detailed usage and cost data.
    Properties:
      Export:
        Description: "CUR 2.0 export for DigiUsher"
        Name: !Ref DataExportName
        DataQuery:
          QueryStatement: !FindInMap [DataExports, CUR2, DefaultQuery]
          TableConfigurations:
            COST_AND_USAGE_REPORT:
              TIME_GRANULARITY: "DAILY"
              INCLUDE_RESOURCES: "TRUE"
              INCLUDE_MANUAL_DISCOUNT_COMPATIBILITY: "FALSE"
              INCLUDE_SPLIT_COST_ALLOCATION_DATA: "TRUE"
        RefreshCadence:
          Frequency: "SYNCHRONOUS"
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !If [CreateBucket, !Ref DigiusherS3Bucket, !Ref BucketName]
            S3Prefix: reports/cur2
            S3Region: !Ref AWS::Region
            S3OutputConfigurations:
              Overwrite: "OVERWRITE_REPORT"
              Format: "PARQUET"
              Compression: "PARQUET"
              OutputType: "CUSTOM"
      Tags:
        - Key: ManagedBy
          Value: DigiUsher

  # Carbon Footprint Report Export
  DigiUsherCarbonFootprint:
    Type: AWS::BCMDataExports::Export
    Condition: EnableCarbonFootprintReport
    DependsOn:
      - !If [CreateBucket, !Ref DigiusherS3BucketPolicy, !Ref AWS::NoValue]
    Description: |
      Creates a Carbon Footprint Report export to track environmental impact.
    Properties:
      Export:
        Description: "Carbon Footprint export for DigiUsher"
        Name: !Sub "${DataExportName}_CarbonFootprint"
        DataQuery:
          QueryStatement: "SELECT * FROM CARBON_FOOTPRINT"
          TableConfigurations: {}
        RefreshCadence:
          Frequency: "SYNCHRONOUS"
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !If [CreateBucket, !Ref DigiusherS3Bucket, !Ref BucketName]
            S3Prefix: reports/carbon-footprint
            S3Region: !Ref AWS::Region
            S3OutputConfigurations:
              Overwrite: "OVERWRITE_REPORT"
              Format: "PARQUET"
              Compression: "PARQUET"
              OutputType: "CUSTOM"
      Tags:
        - Key: ManagedBy
          Value: DigiUsher

  # IAM Role for DigiUsher
  DigiusherIAMRole:
    Type: AWS::IAM::Role
    Description: |
      Creates an IAM role with a trust relationship to DigiUsher's account.
      Implements ExternalId to prevent the confused deputy problem.
      Provides read-only access to cost, usage, and recommendation data.
    Properties:
      RoleName: !Ref RoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowDigiUsherAssumeRole
            Effect: Allow
            Principal:
              AWS: "arn:aws:iam::058264546051:root"
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalId
      ManagedPolicyArns: []
      Policies:
        - PolicyName: DigiUsherCorePermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: DigiUsherRecommendationsPermissions
                Effect: Allow
                Action:
                  - application-autoscaling:Describe*
                  - autoscaling:Describe*
                  - aws-marketplace:ListEntities
                  - budgets:ViewBudget
                  - ce:Describe*
                  - ce:Get*
                  - cloudfront:GetDistributionConfig
                  - cloudfront:ListDistributions
                  - cloudwatch:Get*
                  - cloudwatch:Link
                  - cloudwatch:List*
                  - compute-optimizer:Get*
                  - compute-optimizer:UpdateEnrollmentStatus
                  - cur:Describe*
                  - cur:Get*
                  - dynamodb:Describe*
                  - dynamodb:List*
                  - ec2:Describe*
                  - ecs:Describe*
                  - ecs:List*
                  - elasticache:Describe*
                  - iam:GetAccessKeyLastUsed
                  - iam:GetLoginProfile
                  - iam:ListAccessKeys
                  - iam:ListUsers
                  - invoicing:*
                  - organizations:DescribeAccount
                  - organizations:DescribeOrganization
                  - organizations:DescribeOrganizationalUnit
                  - organizations:ListAccounts
                  - organizations:ListAccountsForParent
                  - organizations:ListChildren
                  - organizations:ListOrganizationalUnitsForParent
                  - organizations:ListParents
                  - organizations:ListRoots
                  - organizations:ListTagsForResource
                  - rds:DescribeDBInstances
                  - rds:PurchaseReservedDbInstancesOffering
                  - resourcegroups:GetGroup
                  - resourcegroups:ListGroups
                  - s3:GetBucketAcl
                  - s3:GetBucketLocation
                  - s3:GetBucketPolicyStatus
                  - s3:GetBucketPublicAccessBlock
                  - s3:GetBucketTagging
                  - s3:ListAllMyBuckets
                  - savingsplans:CreateSavingsPlan
                  - savingsplans:DescribeSavingsPlans
                  - savingsplans:DescribeSavingsPlansOfferings
                  - servicequotas:Get*
                  - servicequotas:List*
                  - ssm:CreateChangeRequest
                  - ssm:DeleteChangeRequest
                  - ssm:ListChangeRequests
                  - ssm:UpdateChangeRequest
                  - sustainability:GetCarbonFootprintSummary
                  - tag:GetResources
                  - tag:GetTagKeys
                  - tag:GetTagValues
                  - tag:TagResources
                  - tag:UntagResources
                  - trustedadvisor:Describe*
                  - trustedadvisor:GenerateReport
                  - trustedadvisor:Get*
                  - trustedadvisor:List*
                  - xray:BatchGetTraces
                  - xray:GetTraceSummaries
                Resource: "*"
        - !If
          - NeedsBucketAccess
          - PolicyName: DigiUsherS3CURAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Sid: DigiUsherCURPermissions
                  Effect: Allow
                  Action:
                    - s3:GetObject
                    - s3:ListBucket
                  Resource:
                    - !Sub 'arn:aws:s3:::${BucketName}'
                    - !Sub 'arn:aws:s3:::${BucketName}/*'
          - !Ref AWS::NoValue
        - !If
          - IncludeEC2StartStopPermissionsCondition
          - PolicyName: DigiUsherEC2StartStopPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Sid: EC2StartStopPermissions
                  Effect: Allow
                  Action:
                    - ec2:StartInstances
                    - ec2:StopInstances
                  Resource: "*"
          - !Ref AWS::NoValue
        - !If
          - IncludeS3DuplicateObjectsPermissionCondition
          - PolicyName: DigiUsherS3DuplicateObjectsPolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Sid: S3DuplicateObjectsPermission
                  Effect: Allow
                  Action:
                    - s3:ListBucket
                  Resource: "*"
          - !Ref AWS::NoValue
      Tags:
        - Key: ManagedBy
          Value: DigiUsher

Outputs:
  IAMRoleArn:
    Description: ARN of the IAM role for DigiUsher to assume
    Value: !GetAtt DigiusherIAMRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RoleArn"

  IAMRoleName:
    Description: Name of the IAM role
    Value: !Ref RoleName
    Export:
      Name: !Sub "${AWS::StackName}-RoleName"

  BucketName:
    Condition: NeedsBucketAccess
    Description: S3 bucket name for Cost and Usage Reports
    Value: !If [CreateBucket, !Ref DigiusherS3Bucket, !Ref BucketName]
    Export:
      Name: !Sub "${AWS::StackName}-BucketName"

  DataExportName:
    Condition: CreateDataExport
    Description: Name of the Cost and Usage Report export
    Value: !Ref DataExportName
    Export:
      Name: !Sub "${AWS::StackName}-DataExportName"

  CURVersion:
    Condition: CreateDataExport
    Description: Version of Cost and Usage Report created
    Value: !Ref CURVersion

  CarbonFootprintEnabled:
    Condition: EnableCarbonFootprintReport
    Description: Carbon Footprint Report export name
    Value: !Sub "${DataExportName}_CarbonFootprint"

  S3Prefix:
    Condition: CreateDataExport
    Description: S3 prefix path for the reports
    Value: !If
      - IsCUR1
      - "reports/cur1"
      - "reports/cur2"

  DeploymentInstructions:
    Description: Deployment information and next steps
    Value: !Sub |
      Successfully deployed DigiUsher IAM role: ${RoleName}
      Account Type: ${AccountType}
      Deployment Scenario: ${DeploymentScenario}

      Share the following information with DigiUsher:
      - Role ARN: ${DigiusherIAMRole.Arn}
      - External ID: (Keep this secure - you provided it during deployment)
      ${!If [NeedsBucketAccess, !Sub '- Bucket Name: ${!If [CreateBucket, !Ref DigiusherS3Bucket, !Ref BucketName]}', '']}
      ${!If [CreateDataExport, !Sub '- Data Export Name: ${DataExportName}', '']}
      ${!If [CreateDataExport, !Sub '- CUR Version: ${CURVersion}', '']}
