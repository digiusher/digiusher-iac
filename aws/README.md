# DigiUsher CloudFormation Template

## Overview

The **DigiUsher.yaml** template provides a single, comprehensive CloudFormation solution for all DigiUsher AWS integration scenarios. This replaces the previous multiple separate templates with one flexible, parameter-driven template.

## Table of Contents

- [Key Features](#key-features)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Deployment Scenarios](#deployment-scenarios)
- [Parameters Reference](#parameters-reference)
- [Security](#security)
- [Deployment Examples](#deployment-examples)
- [Outputs](#outputs)
- [Troubleshooting](#troubleshooting)
- [Migration from Legacy Templates](#migration-from-legacy-templates)

## Key Features

### Security

- **ExternalId Support**: Implements ExternalId in IAM role trust policy
- **Least Privilege Access**: Role grants only necessary read-only permissions for cost and usage data
- **Secure S3 Buckets**: Created buckets have public access blocked and versioning enabled
- **Conditional Permissions**: Optional permissions can be enabled/disabled as needed

### Flexibility

- **Multiple Deployment Scenarios**: Single template supports all use cases
- **CUR Version Selection**: Choose between CUR 1.0 or CUR 2.0
- **Carbon Footprint Reporting**: Optional environmental impact tracking
- **Account Type Support**: Both root and linked accounts
- **Extended Permissions**: Includes invoicing and organizations:ListAccounts

## Prerequisites

1. **AWS Account Access**: Administrative permissions to create IAM roles, S3 buckets, and CUR exports
2. **AWS CLI**: Version 2.x or later (or use AWS Console)
3. **Region**: Must deploy in **us-east-1** for billing-related resources
4. **ExternalId**: **DigiUsher will provide you with a unique ExternalId** when you connect your AWS account

### Getting Your ExternalId

**DigiUsher generates and provides the ExternalId** for you during the account connection process:

1. Log into your DigiUsher account
2. Navigate to AWS account connection settings
3. DigiUsher will display a unique ExternalId for your account
4. Copy this ExternalId and use it in the CloudFormation template deployment

**Security Note**: The ExternalId is generated by DigiUsher to ensure uniqueness and security. This prevents the confused deputy problem by ensuring only DigiUsher can assume the IAM role when providing the correct ExternalId.

## Quick Start

**Before deploying**: Get your ExternalId from DigiUsher (see [Prerequisites](#prerequisites))

### 1. Root Account - New Bucket and CUR 2.0 (Most Common)

```bash
# Replace EXTERNAL_ID_FROM_DIGIUSHER with the ExternalId provided by DigiUsher
aws cloudformation create-stack \
  --stack-name digiusher-integration \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-east-1 \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Root \
    ParameterKey=DeploymentScenario,ParameterValue=NewBucketNewExport \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue=EXTERNAL_ID_FROM_DIGIUSHER \
    ParameterKey=BucketName,ParameterValue=my-org-digiusher-cur \
    ParameterKey=CURVersion,ParameterValue=CUR2 \
    ParameterKey=EnableCarbonFootprint,ParameterValue=yes
```

### 2. Linked Account (Single Account)

```bash
# Replace EXTERNAL_ID_FROM_DIGIUSHER with the ExternalId provided by DigiUsher
aws cloudformation create-stack \
  --stack-name digiusher-linked \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-east-1 \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Linked \
    ParameterKey=DeploymentScenario,ParameterValue=LinkedAccount \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue=EXTERNAL_ID_FROM_DIGIUSHER
```

### 3. Multiple Linked Accounts (Using StackSets)

For AWS Organizations with multiple linked accounts, use StackSets to deploy to all accounts at once:

```bash
# Step 1: Create the StackSet (run from Organization management account)
aws cloudformation create-stack-set \
  --stack-set-name digiusher-linked-accounts \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Linked \
    ParameterKey=DeploymentScenario,ParameterValue=LinkedAccount \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue=EXTERNAL_ID_FROM_DIGIUSHER \
  --description "DigiUsher IAM roles for linked accounts" \
  --permission-model SERVICE_MANAGED \
  --auto-deployment Enabled=true,RetainStacksOnAccountRemoval=false

# Step 2: Deploy to specific accounts
aws cloudformation create-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --accounts 111111111111 222222222222 333333333333 \
  --regions us-east-1 \
  --operation-preferences \
    FailureTolerancePercentage=0,MaxConcurrentPercentage=100

# Step 3: Or deploy to entire organization
aws cloudformation create-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --deployment-targets OrganizationalUnitIds=ou-xxxx-xxxxxxxx \
  --regions us-east-1 \
  --operation-preferences \
    FailureTolerancePercentage=10,MaxConcurrentPercentage=50

# Monitor deployment status
aws cloudformation list-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --output table
```

## Deployment Scenarios

### Scenario 1: Root Account - New Bucket with New Export

**When to use**: First-time setup, no existing CUR or bucket

**What gets created**:
- ✅ New S3 bucket with secure settings
- ✅ Bucket policy for AWS billing service access
- ✅ CUR 1.0 or CUR 2.0 export
- ✅ Optional Carbon Footprint export
- ✅ IAM role with S3 read access

**Parameters**:
```
AccountType: Root
DeploymentScenario: NewBucketNewExport
RoleName: DigiUsherRole
ExternalId: <your-secure-id>
BucketName: <unique-bucket-name>
CURVersion: CUR2 (or CUR1)
EnableCarbonFootprint: yes (or no)
```

### Scenario 2: Root Account - Existing Bucket with New Export

**When to use**: You have an existing S3 bucket with proper billing permissions

**What gets created**:
- ✅ CUR 1.0 or CUR 2.0 export in your existing bucket
- ✅ Optional Carbon Footprint export
- ✅ IAM role with S3 read access

**Prerequisites**:
- Existing S3 bucket in us-east-1
- Bucket must have billing service permissions (see [bucket policy](#bucket-policy-for-existing-buckets))

**Parameters**:
```
AccountType: Root
DeploymentScenario: ExistingBucketNewExport
RoleName: DigiUsherRole
ExternalId: <your-secure-id>
BucketName: <existing-bucket-name>
CURVersion: CUR2 (or CUR1)
```

### Scenario 3: Root Account - Existing Bucket with Existing Export

**When to use**: You already have a CUR configured and just need the IAM role

**What gets created**:
- ✅ IAM role with S3 read access only

**Prerequisites**:
- Existing S3 bucket with CUR data
- Existing CUR export configured

**Parameters**:
```
AccountType: Root
DeploymentScenario: ExistingBucketExistingExport
RoleName: DigiUsherRole
ExternalId: <your-secure-id>
BucketName: <existing-bucket-name>
```

### Scenario 4: Linked Account

**When to use**: For AWS organization member accounts (non-payer accounts)

**What gets created**:
- ✅ IAM role with read-only permissions (no CUR/bucket resources)

**Note**: Linked accounts don't create CUR exports; they use the root account's CUR

**Parameters**:
```
AccountType: Linked
DeploymentScenario: LinkedAccount
RoleName: DigiUsherRole
ExternalId: <your-secure-id>
```

## Parameters Reference

| Parameter | Required | Type | Default | Description |
|-----------|----------|------|---------|-------------|
| **AccountType** | Yes | String | `Root` | Account type: `Root` or `Linked` |
| **DeploymentScenario** | Yes | String | `NewBucketNewExport` | Deployment scenario (see scenarios above) |
| **RoleName** | Yes | String | - | Name for the IAM role DigiUsher will assume |
| **ExternalId** | Yes | String (NoEcho) | - | Secure external ID for role assumption (2-1224 chars) |
| **BucketName** | Conditional | String | `""` | S3 bucket name (required for root account scenarios with bucket access) |
| **DataExportName** | No | String | `DigiUsher_CUR_Export` | Name for the CUR export |
| **CURVersion** | No | String | `CUR2` | CUR version: `CUR1` or `CUR2` |
| **EnableCarbonFootprint** | No | String | `no` | Enable Carbon Footprint export: `yes` or `no` |
| **IncludeEC2StartStopPermissions** | No | String | `no` | Include EC2 start/stop permissions: `yes` or `no` |
| **IncludeCommitmentPurchasePermissions** | No | String | `no` | Include RI/Savings Plans purchase permissions: `yes` or `no` |
| **IncludeTagManagementPermissions** | No | String | `no` | Include tag management permissions across services: `yes` or `no` |
| **IncludeAutomationPermissions** | No | String | `no` | Include SSM runbook and automation permissions: `yes` or `no` |

### Parameter Validation

The template includes built-in validation:

- ✅ BucketName is required when needed for the deployment scenario
- ✅ Must deploy in us-east-1 for billing resources
- ✅ ExternalId must be 2-1224 characters
- ✅ RoleName must be 1-64 characters

## Security

### Confused Deputy Prevention (ExternalId)

The template implements the **ExternalId** condition in the IAM role trust policy. This prevents the confused deputy problem where a malicious actor could trick DigiUsher's service into accessing your account.

**How it works**:
1. You generate a unique, random ExternalId
2. You configure it in the CloudFormation stack
3. You share it securely with DigiUsher
4. DigiUsher must provide this ExternalId when assuming the role
5. AWS verifies the ExternalId matches before allowing access

**IAM Role Trust Policy** (automatically configured):
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::058264546051:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "YOUR_EXTERNAL_ID"
        }
      }
    }
  ]
}
```

### IAM Permissions Granted

The IAM role grants the following permissions:

**Read-Only Permissions** (always included):
- Cost Explorer, Billing, Cost & Usage Reports, and BCM Data Exports
- Compute: EC2, ECS, EKS, Lambda, Auto Scaling, ELB, Compute Optimizer
- Databases: RDS, DynamoDB, ElastiCache, MemoryDB, Redshift, DocumentDB, Neptune, Timestream, DMS
- Storage: S3 metadata, EFS, FSx, Glacier, ECR, Backup
- Networking: CloudFront, Route53, API Gateway
- Data & Analytics: Glue, EMR, Step Functions, Athena, Kinesis, MSK, QuickSight, SageMaker
- Messaging: SQS, SNS, SES, MQ, EventBridge
- Monitoring: CloudWatch, CloudTrail, CloudWatch Logs, X-Ray
- Security: IAM (read-only), KMS, Secrets Manager, GuardDuty, Security Hub, WAF, Config
- Organizations, resource tags, service quotas, Trusted Advisor
- Sustainability/Carbon footprint, Marketplace, Pricing

**Conditional Read-Only Permissions**:
- S3 bucket access (only for the CUR bucket, when applicable)

**Optional Permissions** (disabled by default):
- EC2 start/stop instances (`IncludeEC2StartStopPermissions=yes`)
- RI and Savings Plans purchases (`IncludeCommitmentPurchasePermissions=yes`)
- Tag management across services (`IncludeTagManagementPermissions=yes`)
- SSM runbook management and automation (`IncludeAutomationPermissions=yes`)

### S3 Bucket Security

When the template creates an S3 bucket, it includes:

- ✅ **Public Access Block**: All public access is blocked
- ✅ **Versioning**: Enabled for data protection
- ✅ **Lifecycle Policy**: Deletes old versions after 90 days, transitions to Intelligent-Tiering after 180 days
- ✅ **Bucket Policy**: Restricts access to AWS billing services only
- ✅ **Encryption**: Uses AWS-managed encryption (default)

## Deployment Examples

### Example 1: Root Account with CUR 2.0 and Carbon Footprint

```bash
# Get the ExternalId from DigiUsher before running this
# Log into DigiUsher → AWS Connection Settings → Copy ExternalId
EXTERNAL_ID="PASTE_EXTERNAL_ID_FROM_DIGIUSHER_HERE"

# Deploy stack
aws cloudformation create-stack \
  --stack-name digiusher-root-cur2 \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-east-1 \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Root \
    ParameterKey=DeploymentScenario,ParameterValue=NewBucketNewExport \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue="$EXTERNAL_ID" \
    ParameterKey=BucketName,ParameterValue=acme-corp-digiusher-cur \
    ParameterKey=DataExportName,ParameterValue=AcmeCorp_CUR \
    ParameterKey=CURVersion,ParameterValue=CUR2 \
    ParameterKey=EnableCarbonFootprint,ParameterValue=yes \
  --tags Key=Environment,Value=Production Key=ManagedBy,Value=DigiUsher

# Monitor stack creation
aws cloudformation wait stack-create-complete \
  --stack-name digiusher-root-cur2 \
  --region us-east-1

# Get outputs
aws cloudformation describe-stacks \
  --stack-name digiusher-root-cur2 \
  --region us-east-1 \
  --query 'Stacks[0].Outputs'
```

### Example 2: Existing Bucket with CUR 1.0

```bash
# Get the ExternalId from DigiUsher before running this
aws cloudformation create-stack \
  --stack-name digiusher-root-existing \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --region us-east-1 \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Root \
    ParameterKey=DeploymentScenario,ParameterValue=ExistingBucketNewExport \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue=EXTERNAL_ID_FROM_DIGIUSHER \
    ParameterKey=BucketName,ParameterValue=my-existing-billing-bucket \
    ParameterKey=CURVersion,ParameterValue=CUR1
```

### Example 3: AWS Console Deployment

**Before starting**: Get the ExternalId from DigiUsher (log into DigiUsher → AWS Connection Settings)

1. **Download the template**: Save `DigiUsher.yaml` to your computer

2. **Open CloudFormation Console**:
   - Go to https://console.aws.amazon.com/cloudformation
   - **Important**: Select **us-east-1** region (top-right corner)

3. **Create Stack**:
   - Click "Create stack" → "With new resources (standard)"
   - Choose "Upload a template file"
   - Click "Choose file" and select `DigiUsher.yaml`
   - Click "Next"

4. **Specify Stack Details**:
   - **Stack name**: `digiusher-integration`
   - Fill in parameters:
     - Account Type: `Root`
     - Deployment Scenario: `NewBucketNewExport`
     - Role Name: `DigiUsherRole`
     - **External ID**: (paste the ExternalId from DigiUsher)
     - Bucket Name: `your-unique-bucket-name`
     - CUR Version: `CUR2`
     - Enable Carbon Footprint: `yes`
   - Click "Next"

5. **Configure Stack Options**:
   - Add tags (optional): `ManagedBy=DigiUsher`
   - Click "Next"

6. **Review**:
   - Review all settings
   - Check "I acknowledge that AWS CloudFormation might create IAM resources with custom names"
   - Click "Create stack"

7. **Monitor Progress**:
   - Watch the "Events" tab for progress
   - Wait for status: `CREATE_COMPLETE` (typically 2-5 minutes)

8. **Get Outputs**:
   - Go to "Outputs" tab
   - Copy the `IAMRoleArn` and other values
   - Provide the Role ARN back to DigiUsher to complete the connection

### Example 4: Multiple Linked Accounts with StackSets

**Use StackSets to deploy IAM roles across multiple AWS Organization accounts**

```bash
# Get the ExternalId from DigiUsher before running this
EXTERNAL_ID="PASTE_EXTERNAL_ID_FROM_DIGIUSHER_HERE"

# Step 1: Create the StackSet (run from Organization management account)
aws cloudformation create-stack-set \
  --stack-set-name digiusher-linked-accounts \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Linked \
    ParameterKey=DeploymentScenario,ParameterValue=LinkedAccount \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue="$EXTERNAL_ID" \
  --description "DigiUsher IAM roles for linked accounts" \
  --permission-model SERVICE_MANAGED \
  --auto-deployment Enabled=true,RetainStacksOnAccountRemoval=false

# Step 2a: Deploy to specific accounts by account ID
aws cloudformation create-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --accounts 111111111111 222222222222 333333333333 \
  --regions us-east-1 \
  --operation-preferences \
    FailureTolerancePercentage=0,MaxConcurrentPercentage=100,RegionConcurrencyType=PARALLEL

# Step 2b: OR deploy to all accounts in an Organizational Unit
aws cloudformation create-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --deployment-targets OrganizationalUnitIds=ou-xxxx-xxxxxxxx \
  --regions us-east-1 \
  --operation-preferences \
    FailureTolerancePercentage=10,MaxConcurrentPercentage=50,RegionConcurrencyType=PARALLEL

# Step 3: Monitor deployment progress
aws cloudformation list-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --output table

# Step 4: Check for failures
aws cloudformation list-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --filters Key=Status,Values=FAILED \
  --output table

# Step 5: Get detailed operation status
aws cloudformation list-stack-set-operations \
  --stack-set-name digiusher-linked-accounts \
  --max-results 5
```

**For self-managed StackSets** (if not using AWS Organizations):

```bash
# Create StackSet with self-managed permissions
aws cloudformation create-stack-set \
  --stack-set-name digiusher-linked-accounts \
  --template-body file://DigiUsher.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters \
    ParameterKey=AccountType,ParameterValue=Linked \
    ParameterKey=DeploymentScenario,ParameterValue=LinkedAccount \
    ParameterKey=RoleName,ParameterValue=DigiUsherRole \
    ParameterKey=ExternalId,ParameterValue="$EXTERNAL_ID" \
  --description "DigiUsher IAM roles for linked accounts" \
  --permission-model SELF_MANAGED \
  --administration-role-arn arn:aws:iam::MGMT_ACCOUNT_ID:role/AWSCloudFormationStackSetAdministrationRole \
  --execution-role-name AWSCloudFormationStackSetExecutionRole

# Deploy to accounts
aws cloudformation create-stack-instances \
  --stack-set-name digiusher-linked-accounts \
  --accounts 111111111111 222222222222 333333333333 \
  --regions us-east-1 \
  --operation-preferences \
    FailureToleranceCount=0,MaxConcurrentCount=5
```

## Outputs

After successful deployment, the stack provides these outputs:

| Output | Description | When Available |
|--------|-------------|----------------|
| **IAMRoleArn** | ARN of the IAM role (share with DigiUsher) | Always |
| **IAMRoleName** | Name of the IAM role | Always |
| **BucketName** | S3 bucket name for CUR data | Root accounts with bucket access |
| **DataExportName** | Name of the CUR export | When new export is created |
| **CURVersion** | Version of CUR created (CUR1 or CUR2) | When new export is created |
| **CarbonFootprintEnabled** | Carbon Footprint export name | When carbon footprint is enabled |
| **S3Prefix** | S3 prefix path for reports | When new export is created |
| **DeploymentInstructions** | Summary and next steps | Always |

### Retrieving Outputs

**AWS CLI**:
```bash
aws cloudformation describe-stacks \
  --stack-name digiusher-integration \
  --region us-east-1 \
  --query 'Stacks[0].Outputs' \
  --output table
```

**AWS Console**:
1. Go to CloudFormation → Stacks
2. Select your stack
3. Click "Outputs" tab

## Bucket Policy for Existing Buckets

If using `ExistingBucketNewExport` scenario, ensure your bucket has this policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowBillingServiceAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": [
          "billingreports.amazonaws.com",
          "bcm-data-exports.amazonaws.com"
        ]
      },
      "Action": [
        "s3:GetBucketAcl",
        "s3:GetBucketPolicy",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::YOUR_BUCKET_NAME",
        "arn:aws:s3:::YOUR_BUCKET_NAME/*"
      ],
      "Condition": {
        "StringLike": {
          "aws:SourceArn": [
            "arn:aws:cur:us-east-1:YOUR_ACCOUNT_ID:definition/*",
            "arn:aws:bcm-data-exports:us-east-1:YOUR_ACCOUNT_ID:export/*"
          ]
        },
        "StringEquals": {
          "aws:SourceAccount": "YOUR_ACCOUNT_ID"
        }
      }
    }
  ]
}
```

## Troubleshooting

### Common Issues

#### 1. "Stack creation failed: Must be deployed in us-east-1"

**Problem**: You're deploying in the wrong region

**Solution**:
```bash
# Always use --region us-east-1
aws cloudformation create-stack \
  --region us-east-1 \
  ...
```

#### 2. "CUR export creation failed: Access Denied on bucket"

**Problem**: Bucket doesn't have billing service permissions

**Solutions**:
- For new bucket scenario: Check if bucket name already exists globally
- For existing bucket: Add the [bucket policy](#bucket-policy-for-existing-buckets)
- Verify bucket is in us-east-1

#### 3. "Role already exists"

**Problem**: A role with the same name already exists

**Solutions**:
```bash
# Option 1: Use a different role name
--parameters ParameterKey=RoleName,ParameterValue=DigiUsherRole2

# Option 2: Delete existing role first
aws iam delete-role --role-name DigiUsherRole

# Option 3: Update existing stack instead
aws cloudformation update-stack --stack-name digiusher-integration ...
```

#### 4. "Parameter validation failed: BucketName is required"

**Problem**: BucketName not provided for root account scenario

**Solution**: Always provide BucketName for root account scenarios:
```bash
--parameters ParameterKey=BucketName,ParameterValue=my-bucket-name
```

#### 5. "Stack creation failed: Bucket already exists"

**Problem**: Bucket name is already taken (S3 bucket names are globally unique)

**Solution**: Choose a different, unique bucket name:
```bash
# Use organization prefix + random suffix
ParameterKey=BucketName,ParameterValue=acme-corp-digiusher-cur-a3f8e2
```

### Validation and Testing

**Validate template syntax**:
```bash
aws cloudformation validate-template \
  --template-body file://DigiUsher.yaml \
  --region us-east-1
```

**Check stack events** (during creation):
```bash
aws cloudformation describe-stack-events \
  --stack-name digiusher-integration \
  --region us-east-1 \
  --max-items 20
```

**Verify CUR was created**:
```bash
# For CUR 2.0
aws bcm-data-exports list-exports --region us-east-1

# For CUR 1.0
aws cur describe-report-definitions --region us-east-1
```

**Test IAM role assumption**:
```bash
# This should be done by DigiUsher, but you can test locally
aws sts assume-role \
  --role-arn arn:aws:iam::YOUR_ACCOUNT_ID:role/DigiUsherRole \
  --role-session-name test \
  --external-id YOUR_EXTERNAL_ID \
  --duration-seconds 900
```

### Getting Help

If you encounter issues:

1. Check CloudFormation Events tab for detailed error messages
2. Verify all prerequisites are met
3. Review this troubleshooting section
4. Check AWS Service Health Dashboard
5. Contact DigiUsher support with:
   - Stack name and region
   - CloudFormation events (sanitize any sensitive info)
   - Parameters used (except ExternalId)

## Updating Existing Deployments

If you have an existing DigiUsher CloudFormation stack deployed:

**Option 1: Delete and Redeploy (Recommended)**

1. Note your current bucket name and configuration
2. Delete the old stack: `aws cloudformation delete-stack --stack-name DigiUsher --region us-east-1`
3. Deploy this template using the `ExistingBucketExistingExport` scenario
4. Update DigiUsher with the new Role ARN

**Option 2: Side-by-Side Deployment**

1. Deploy this template with a different role name (e.g., `DigiUsherRoleV2`)
2. Update DigiUsher to use the new role
3. Once verified, delete the old stack

## Best Practices

1. **ExternalId Management**:
   - DigiUsher provides a unique ExternalId for each account connection
   - Copy the ExternalId from DigiUsher's UI when setting up the CloudFormation stack
   - Never share your ExternalId publicly or in source control
   - DigiUsher uses different ExternalIds for different AWS accounts automatically

2. **Tag Your Stacks**:
   ```bash
   --tags Key=Environment,Value=Production \
          Key=ManagedBy,Value=DigiUsher \
          Key=CostCenter,Value=FinOps
   ```

3. **Enable Carbon Footprint Reporting**:
   - Helps track environmental impact
   - No additional cost
   - Recommended for ESG compliance

4. **Use CUR 2.0**:
   - More features and better performance
   - Recommended by AWS for new deployments
   - Backward compatible with CUR 1.0 tools

5. **Bucket Naming**:
   - Use organization prefix: `acme-corp-digiusher-cur`
   - Include environment: `acme-corp-digiusher-cur-prod`
   - S3 bucket names must be globally unique

6. **Monitor Stack Drift**:
   ```bash
   aws cloudformation detect-stack-drift --stack-name digiusher-integration
   aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id <id>
   ```

## Additional Resources

- [AWS Cost and Usage Reports User Guide](https://docs.aws.amazon.com/cur/latest/userguide/)
- [AWS CloudFormation Best Practices](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html)
- [IAM Roles for Cross-Account Access](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_aws-accounts.html)
- [Confused Deputy Problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)
- [DigiUsher Documentation](https://docs.digiusher.com) (replace with actual URL)

## Support

For assistance:
- **Technical Issues**: Review troubleshooting section and CloudFormation events
- **DigiUsher Support**: Contact DigiUsher support team
- **AWS Support**: For AWS-specific issues (CUR, CloudFormation, IAM)

---

**Template Version**: 1.0  
**Last Updated**: 2025-11-15  
**Maintained By**: DigiUsher


